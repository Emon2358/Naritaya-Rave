<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>レトロ掲示板＆ブログ</title>
  <!-- marked.js CDN（Markdown → HTML 変換用） -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* 全体のレトロ感（昔ながらの掲示板風） */
    body {
      background-color: #f0e68c; /* 和紙風の明るい色 */
      font-family: "Courier New", Courier, monospace;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #003366;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    nav {
      display: flex;
      justify-content: center;
      background-color: #336699;
    }
    nav button {
      background: none;
      border: none;
      padding: 1rem 2rem;
      font-size: 1rem;
      color: #fff;
      cursor: pointer;
    }
    nav button.active {
      background-color: #003366;
    }
    .container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 1rem;
      background-color: #fff;
      border: 2px solid #003366;
    }
    /* 掲示板投稿用スタイル */
    .post {
      border-bottom: 1px dashed #ccc;
      padding: 1rem 0;
    }
    .post:last-child {
      border-bottom: none;
    }
    .post h2 {
      font-size: 1.2rem;
      margin: 0;
      color: #003366;
    }
    .post p.date {
      font-size: 0.8rem;
      color: #666;
      margin: 0.5rem 0;
    }
    /* ブログ投稿一覧用スタイル */
    .blog-post {
      border-bottom: 1px dashed #ccc;
      padding: 1rem 0;
      cursor: pointer;
    }
    .blog-post:last-child {
      border-bottom: none;
    }
    .blog-post h3 {
      font-size: 1.1rem;
      margin: 0;
      color: #003366;
    }
    .blog-post:hover {
      background-color: #f9f9f9;
    }
    /* ボタンスタイル */
    button.action-btn {
      display: block;
      margin: 1rem 0;
      padding: 0.5rem 1rem;
      background-color: #003366;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }
    /* ブログ詳細表示用 */
    #blog-detail {
      display: none;
    }
    #blog-detail h2 {
      color: #003366;
    }
    #back-button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      background-color: #666;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>レトロ掲示板＆ブログ</h1>
  </header>
  <nav>
    <button id="bbs-tab" class="active">掲示板</button>
    <button id="blog-tab">ブログ</button>
  </nav>
  
  <!-- 掲示板セクション -->
  <div id="bbs-section" class="container">
    <h2>掲示板投稿一覧</h2>
    <div id="bbs-posts">
      <p>読み込み中…</p>
    </div>
    <button id="new-post" class="action-btn">新規投稿</button>
  </div>
  
  <!-- ブログセクション（初期は非表示） -->
  <div id="blog-section" class="container" style="display: none;">
    <!-- ブログ一覧表示エリア -->
    <div id="blog-list">
      <h2>ブログ投稿一覧</h2>
      <div id="blog-posts">
        <p>読み込み中…</p>
      </div>
      <!-- 新規ブログ投稿（GitHub 上でファイル作成画面へ遷移） -->
      <button id="new-blog" class="action-btn">新規ブログ投稿</button>
    </div>
    <!-- ブログ詳細表示エリア -->
    <div id="blog-detail">
      <!-- タイトル -->
      <h2 id="blog-title"></h2>
      <!-- コンテンツ -->
      <div id="blog-content"></div>
      <!-- 戻るボタン -->
      <button id="back-button">一覧に戻る</button>
    </div>
  </div>

  <script>
    /**********************************
     * GitHub の設定（変更必須）
     **********************************/
    const owner = 'Emon2358';  // 例: 'tanaka'
    const repo  = 'regahonpo';        // 例: 'bbs-repo'
    // ブログ投稿は同一リポジトリ内の "blog" フォルダを対象とします

    /**********************************
     * タブ切替の処理
     **********************************/
    const bbsTab = document.getElementById('bbs-tab');
    const blogTab = document.getElementById('blog-tab');
    const bbsSection = document.getElementById('bbs-section');
    const blogSection = document.getElementById('blog-section');

    bbsTab.addEventListener('click', () => {
      bbsTab.classList.add('active');
      blogTab.classList.remove('active');
      bbsSection.style.display = 'block';
      blogSection.style.display = 'none';
    });
    blogTab.addEventListener('click', () => {
      blogTab.classList.add('active');
      bbsTab.classList.remove('active');
      blogSection.style.display = 'block';
      bbsSection.style.display = 'none';
      // 初回のみブログ投稿一覧を読み込む
      if (!blogSection.dataset.loaded) {
        fetchBlogPosts();
        blogSection.dataset.loaded = true;
      }
    });

    /**********************************
     * 掲示板（BBS）機能
     **********************************/
    async function fetchBbsPosts() {
      const postsContainer = document.getElementById('bbs-posts');
      try {
        const apiUrl = `https://api.github.com/repos/${owner}/${repo}/issues?state=open`;
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error('投稿の読み込みに失敗しました。');
        }
        const issues = await response.json();
        displayBbsPosts(issues);
      } catch (error) {
        console.error(error);
        postsContainer.innerHTML = '<p>投稿の読み込みに失敗しました。</p>';
      }
    }

    function displayBbsPosts(issues) {
      const postsContainer = document.getElementById('bbs-posts');
      postsContainer.innerHTML = '';
      if (issues.length === 0) {
        postsContainer.innerHTML = '<p>現在、投稿はありません。</p>';
        return;
      }
      issues.forEach(issue => {
        const postDiv = document.createElement('div');
        postDiv.className = 'post';

        // タイトル
        const titleEl = document.createElement('h2');
        titleEl.textContent = issue.title;
        postDiv.appendChild(titleEl);

        // 投稿日時
        const dateEl = document.createElement('p');
        dateEl.className = 'date';
        dateEl.textContent = '投稿日時: ' + new Date(issue.created_at).toLocaleString();
        postDiv.appendChild(dateEl);

        // 本文
        const bodyEl = document.createElement('p');
        bodyEl.textContent = issue.body || '(本文なし)';
        postDiv.appendChild(bodyEl);

        postsContainer.appendChild(postDiv);
      });
    }

    /**********************************
     * ブログ機能（GitHub Pages 内の blog フォルダ利用）
     **********************************/
    // ブログ一覧を取得
    async function fetchBlogPosts() {
      const postsContainer = document.getElementById('blog-posts');
      try {
        // GitHub API で "blog" フォルダ内のファイル一覧を取得
        const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/blog`;
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error('ブログ投稿の読み込みに失敗しました。');
        }
        const files = await response.json();
        displayBlogPosts(files);
      } catch (error) {
        console.error(error);
        postsContainer.innerHTML = '<p>ブログ投稿の読み込みに失敗しました。</p>';
      }
    }

    // 取得した Markdown ファイル一覧を表示（タイトルはファイル名から拡張子を除いたもの）
    function displayBlogPosts(files) {
      const postsContainer = document.getElementById('blog-posts');
      postsContainer.innerHTML = '';
      // Markdown ファイル（.md）をフィルター
      const mdFiles = files.filter(file => file.name.endsWith('.md'));
      if (mdFiles.length === 0) {
        postsContainer.innerHTML = '<p>現在、ブログ投稿はありません。</p>';
        return;
      }
      // ファイル名（タイトル）の降順（最新順）に並べ替え（※ファイル名に日付等を含めると効果的）
      mdFiles.sort((a, b) => b.name.localeCompare(a.name));
      mdFiles.forEach(file => {
        const postDiv = document.createElement('div');
        postDiv.className = 'blog-post';
        // タイトルはファイル名から拡張子を除いたもの
        const title = file.name.replace('.md', '');
        const titleEl = document.createElement('h3');
        titleEl.textContent = title;
        postDiv.appendChild(titleEl);
        // クリック時にブログ詳細表示へ
        postDiv.addEventListener('click', () => {
          loadBlogPost(file);
        });
        postsContainer.appendChild(postDiv);
      });
    }

    // ブログ投稿の Markdown ファイルを取得して表示
    async function loadBlogPost(file) {
      try {
        const response = await fetch(file.download_url);
        if (!response.ok) {
          throw new Error('ブログ投稿の読み込みに失敗しました。');
        }
        const markdown = await response.text();
        // Markdown を HTML に変換（marked ライブラリを使用）
        const htmlContent = marked.parse(markdown);
        // タイトル（ファイル名から拡張子除去）
        const title = file.name.replace('.md', '');
        // 詳細表示エリアに反映
        document.getElementById('blog-title').textContent = title;
        document.getElementById('blog-content').innerHTML = htmlContent;
        // 一覧表示を隠して詳細表示を表示
        document.getElementById('blog-list').style.display = 'none';
        document.getElementById('blog-detail').style.display = 'block';
      } catch (error) {
        console.error(error);
        alert('ブログ投稿の読み込みに失敗しました。');
      }
    }

    // 詳細表示から一覧に戻る
    document.getElementById('back-button').addEventListener('click', () => {
      document.getElementById('blog-detail').style.display = 'none';
      document.getElementById('blog-list').style.display = 'block';
    });

    /**********************************
     * 各ボタン押下時の処理
     **********************************/
    // 掲示板「新規投稿」ボタン（GitHub Issue の新規作成画面へ）
    document.getElementById('new-post').addEventListener('click', () => {
      window.location.href = `https://github.com/${owner}/${repo}/issues/new`;
    });
    // ブログ「新規ブログ投稿」ボタン（GitHub の新規ファイル作成画面へ）
    document.getElementById('new-blog').addEventListener('click', () => {
      // ※デフォルトブランチが main の場合。必要に応じて branch 名を変更してください。
      window.location.href = `https://github.com/${owner}/${repo}/new/main?filename=blog/`;
    });

    // 初回は掲示板の投稿を読み込む
    fetchBbsPosts();
  </script>
</body>
</html>
